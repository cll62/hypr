#!/usr/bin/env bash
set -euo pipefail

WALLPAPER_DIR="${HOME}/.config/wallpapers"
MATUGEN_CONFIG="${HOME}/.config/matugen/config.toml"
CACHE_DIR="${HOME}/.config/hypr/.cache"
CACHE_WALLPAPER="${CACHE_DIR}/current_wallpaper.png"

[[ -d "$WALLPAPER_DIR" ]] || { notify-send -u critical "Hata" "Duvar kağıdı dizini yok: $WALLPAPER_DIR"; exit 1; }
command -v jq >/dev/null || { notify-send -u critical "Hata" "jq yüklü değil! pacman -S jq"; exit 1; }

mapfile -t WALLPAPERS < <(
    find "$WALLPAPER_DIR" -type f \
        \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) \
        -print | sort -f
)

(( ${#WALLPAPERS[@]} == 0 )) && {
    notify-send -u critical "Hata" "Wallpapers klasöründe resim bulunamadı!";
    exit 1;
}

SELECTED_BASENAME=$(
    printf '%s\n' "${WALLPAPERS[@]##*/}" |
        fuzzel -d  \
            --placeholder="Duvar kağıdı ara..."
)

[[ -z "$SELECTED_BASENAME" ]] && exit 0

SELECTED_WALLPAPER=""
for wp in "${WALLPAPERS[@]}"; do
    if [[ "$(basename "$wp")" == "$SELECTED_BASENAME" ]]; then
        SELECTED_WALLPAPER="$wp"
        break
    fi
done

[[ -z "$SELECTED_WALLPAPER" ]] && {
    notify-send -u low "Hata" "Seçilen dosya bulunamadı.";
    exit 1;
}

mkdir -p "$CACHE_DIR"

FOCUSED_RES=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | "\(.width)x\(.height)"')
[[ -z "$FOCUSED_RES" ]] && FOCUSED_RES="1920x1080"

if command -v magick >/dev/null 2>&1; then
    magick "$SELECTED_WALLPAPER" \
        -strip \
        -resize "${FOCUSED_RES}" \
        -background black \
        -gravity center \
        -extent "${FOCUSED_RES}" \
        "$CACHE_WALLPAPER"
else
    cp "$SELECTED_WALLPAPER" "$CACHE_WALLPAPER"
fi

swww img "$CACHE_WALLPAPER" \
    --transition-fps 120 \
    --transition-type any \
    --transition-duration 1.3 \
    --transition-bezier .28,.58,.99,.37 \
    --transition-step 255 &

if [[ -f "$MATUGEN_CONFIG" ]]; then
    matugen image -c "$MATUGEN_CONFIG" "$SELECTED_WALLPAPER"
else
    matugen image "$SELECTED_WALLPAPER"
fi

if command -v refresh >/dev/null 2>&1; then
    refresh
else
    sleep 0.7
    pkill -SIGUSR2 waybar || true
fi

notify-send -i "$CACHE_WALLPAPER" "Duvar Kağıdı Değiştirildi" \
    "<big><b>$(basename "$SELECTED_WALLPAPER")</b></big>\n ${FOCUSED_RES}"