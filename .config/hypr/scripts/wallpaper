#!/usr/bin/env bash
set -euo pipefail

WALLPAPER_DIR="${HOME}/.config/wallpapers"
MATUGEN_CONFIG="${HOME}/.config/matugen/config.toml"
CACHE_DIR="${HOME}/.config/hypr/.cache"
CACHE_WALLPAPER="${CACHE_DIR}/current_wallpaper.png"
API_URL="https://wallhaven.cc/api/v1/search"
DEBUG_FILE="/tmp/wallhaven_debug.json"

[[ -d "$WALLPAPER_DIR" ]] || mkdir -p "$WALLPAPER_DIR"
mkdir -p "$CACHE_DIR"

for cmd in jq curl fuzzel swww hyprctl magick; do
    command -v $cmd >/dev/null || { notify-send -u critical "Hata" "$cmd y√ºkl√º deƒüil!"; exit 1; }
done

FOCUSED_RES=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | "\(.width)x\(.height)"')
[[ -z "$FOCUSED_RES" ]] && FOCUSED_RES="1920x1080"

SECIM=$(printf "1. üìÅ Yerel Dosyalar\n2. üåê Wallhaven'da Ara" | fuzzel -d --lines=2 --width=30 --prompt="Mod Se√ßin: ")

[[ -z "$SECIM" ]] && exit 0

SELECTED_WALLPAPER=""


if [[ "$SECIM" == "1. üìÅ Yerel Dosyalar" ]]; then
    mapfile -t WALLPAPERS < <(
        find "$WALLPAPER_DIR" -type f \
            \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) \
            -printf "%P\n" | sort -V
    )

    if (( ${#WALLPAPERS[@]} == 0 )); then
        notify-send -u critical "Hata" "Klas√∂rde resim yok: $WALLPAPER_DIR"
        exit 1
    fi

    SELECTED_NAME=$(printf '%s\n' "${WALLPAPERS[@]}" | fuzzel -d --placeholder="Yerel dosya se√ß...")
    [[ -z "$SELECTED_NAME" ]] && exit 0
    
    SELECTED_WALLPAPER="${WALLPAPER_DIR}/${SELECTED_NAME}"

elif [[ "$SECIM" == "2. üåê Wallhaven'da Ara" ]]; then
    
    QUERY=$(echo "" | fuzzel -d --lines=0 --width=40 --prompt="Wallhaven Ara (Bo≈ü=Pop√ºler): " --placeholder="√ñrn: cyberpunk...")
    if [ $? -ne 0 ]; then exit 0; fi

    notify-send -t 2000 "Wallhaven" "$FOCUSED_RES √ß√∂z√ºn√ºrl√ºƒü√ºnde aranƒ±yor..."

    if [[ -z "$QUERY" ]]; then
        API_PARAMS="resolutions=${FOCUSED_RES}&sorting=toplist&purity=100"
    else
        API_PARAMS="q=${QUERY}&resolutions=${FOCUSED_RES}&sorting=relevance&purity=100"
    fi

    if ! curl -s -f "${API_URL}?${API_PARAMS}" > "$DEBUG_FILE"; then
        notify-send -u critical "Hata" "Sunucu hatasƒ± veya internet yok."
        exit 1
    fi

    SELECTED_LINE=$(jq -r '(.data // []) | .[] | "\(.id) | \(.resolution) | \(.path) | [\(.category)] \(.file_type)"' "$DEBUG_FILE" | \
        fuzzel -d --width=90 --prompt="ƒ∞ndir: ")

    if [[ -z "$SELECTED_LINE" ]]; then
        exit 0
    fi

    SELECTED_URL=$(echo "$SELECTED_LINE" | awk -F ' \\| ' '{print $3}')
    EXTENSION="${SELECTED_URL##*.}"

    i=1
    while true; do
        if ! find "$WALLPAPER_DIR" -maxdepth 1 -type f -name "w${i}.*" -print -quit | grep -q .; then
            NEW_FILENAME="w${i}.${EXTENSION}"
            break
        fi
        ((i++))
    done
    
    LOCAL_FILE="${WALLPAPER_DIR}/${NEW_FILENAME}"

    notify-send "ƒ∞ndiriliyor" "$NEW_FILENAME..."
    curl -L -s -o "$LOCAL_FILE" "$SELECTED_URL" || { notify-send "Hata" "ƒ∞ndirme ba≈üarƒ±sƒ±z"; exit 1; }
    
    SELECTED_WALLPAPER="$LOCAL_FILE"
fi


[[ -z "$SELECTED_WALLPAPER" ]] && exit 1

magick "$SELECTED_WALLPAPER" \
    -strip \
    -resize "${FOCUSED_RES}^" \
    -gravity center \
    -extent "${FOCUSED_RES}" \
    "$CACHE_WALLPAPER"

swww img "$CACHE_WALLPAPER" \
    --transition-fps 120 \
    --transition-type any \
    --transition-duration 1.3 \
    --transition-bezier .28,.58,.99,.37 \
    --transition-step 255 &

if [[ -f "$MATUGEN_CONFIG" ]]; then
    matugen image -c "$MATUGEN_CONFIG" "$SELECTED_WALLPAPER"
else
    matugen image "$SELECTED_WALLPAPER"
fi

if command -v refresh >/dev/null 2>&1; then
    refresh
else
    sleep 0.7
    pkill -SIGUSR2 waybar || true
fi

notify-send -i "$CACHE_WALLPAPER" "Tamamlandƒ±" "$(basename "$SELECTED_WALLPAPER")"