#!/bin/bash
set -Eeuo pipefail
IFS=$'\n\t'

# ------------------- MESAJ FONKSÄ°YONLARI -------------------
info()    { echo "[â„¹] $*"; }
success() { echo "[âœ”] $*"; }
warning() { echo "[âš ] $*" >&2; }
error()   { echo "[âœ–] $*" >&2; exit 1; }

# ------------------- GÄ°RÄ°Åž FONKSÄ°YONLARI -------------------
is_yes() {
    [[ "${1,,}" =~ ^(e|evet|y|yes)$ ]]
}
# ------------------- DEÄžÄ°ÅžKENLER -------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REAL_USER=$(whoami)
REAL_HOME=$HOME
AUTO_YES=0
mod=0  # 0: Full Kurulum, 1: Dotfiles

# ------------------- LOG DÄ°ZÄ°NLERÄ° -------------------
LOGDIR="$HOME/.cache/hyprland-logs"
mkdir -p "$LOGDIR"
LOGFILE="$LOGDIR/install-$(date +%Y%m%d_%H%M%S).log"
TMPDIR="${TMPDIR:-/tmp}"

exec > >(tee -a "$LOGFILE") 2>&1
cleanup() {
    rm -rf "$TMPDIR/yay-bin" 2>/dev/null || true
}
trap 'cleanup; echo; echo "[âœ–] Bir hata oluÅŸtu! Log dosyasÄ±nÄ± inceleyin: $LOGFILE"; echo' ERR

{
    echo "========================================================="
    echo " ðŸŒ€ Hyprland Otomatik Kurulum Logu"
    echo " Tarih   : $(date)"
    echo " KullanÄ±cÄ±: $REAL_USER"
    echo " Sistem   : $(lsb_release -d 2>/dev/null | cut -f2 || uname -a)"
    echo " Kabuk    : $SHELL"
    echo "========================================================="
    echo
} >> "$LOGFILE"


# ===============================================================
# Kurulum Modu SeÃ§imi
# ===============================================================
while [[ $# -gt 0 ]]; do
    case "$1" in
        --dotfiles) mod=1 ;;
        --full) mod=0 ;;
        --yes) AUTO_YES=1 ;;
        *) error "GeÃ§ersiz parametre: $1 (KullanÄ±m: --full, --dotfiles, --yes)" ;;
    esac
    shift
done

if [[ "$mod" -eq 1 ]]; then
    info "ðŸŽ¨ Dotfiles modu seÃ§ildi."
else
    info "ðŸ§± Full kurulum modu seÃ§ildi."
fi

# ===============================================================
# Chaotic-AUR Kurulumu
# ===============================================================
setup_chaotic_aur() {
    if [[ "$mod" -eq 1 ]]; then
        info "Dotfiles modunda Chaotic-AUR adÄ±mÄ± atlanÄ±yor."
        return
    fi
    info "Chaotic-AUR anahtarlarÄ± ve mirror listesi kuruluyor..."
    local key="3056513887B78AEB"
    local keyservers=(hkps://keyserver.ubuntu.com hkps://keys.openpgp.org)
    local key_ok=0

    for ks in "${keyservers[@]}"; do
        if sudo pacman-key --recv-key "$key" --keyserver "$ks"; then
            sudo pacman-key --lsign-key "$key"
            success "GPG anahtarÄ± baÅŸarÄ±yla eklendi."
            key_ok=1
            break
        else
            warning "Anahtar alÄ±namadÄ±: $ks"
        fi
    done

    if [[ $key_ok -eq 0 ]]; then
        error "Chaotic-AUR anahtarÄ± eklenemedi. LÃ¼tfen aÄŸ baÄŸlantÄ±nÄ±zÄ± kontrol edin."
    fi

    sudo pacman -U --noconfirm \
        "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst" \
        "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst" \
        || error "Chaotic-AUR paketleri indirilemedi."

    sudo pacman -Syu --noconfirm --needed || warning "chaotic-mirrorlist gÃ¼ncellenemedi."
    success "Chaotic-AUR yapÄ±landÄ±rmasÄ± tamamlandÄ±."
}

# ===============================================================
# pacman.conf YapÄ±landÄ±rmasÄ±
# ===============================================================
configure_pacman() {
    if [[ "$mod" -eq 1 ]]; then
        info "Dotfiles modunda pacman.conf adÄ±mÄ± atlanÄ±yor."
        return
    fi
    info "Yeni /etc/pacman.conf uygulanÄ±yor..."
    local custom_pacman_conf="$SCRIPT_DIR/.config/pacman/pacman.conf"

    if [[ -f "$custom_pacman_conf" ]]; then
        sudo cp /etc/pacman.conf "/etc/pacman.conf.backup.$(date +%Y%m%d_%H%M%S)" || warning "pacman.conf yedeklenemedi."
        sudo cp -f "$custom_pacman_conf" /etc/pacman.conf || error "pacman.conf kopyalanamadÄ±!"
        sudo pacman -Sy --noconfirm || warning "Paket listesi gÃ¼ncellenemedi."
        success "Yeni pacman.conf baÅŸarÄ±yla uygulandÄ±."
    else
        warning "pacman.conf bulunamadÄ±. Chaotic-AUR devre dÄ±ÅŸÄ± kalabilir."
    fi
}

# ===============================================================
# yay Kurulumu
# ===============================================================
setup_yay() {
    if [[ "$mod" -eq 1 ]]; then
        info "Dotfiles modunda yay kurulumu adÄ±mÄ± atlanÄ±yor."
        return
    fi

    if command -v yay &>/dev/null; then
        success "yay zaten kurulu."
        return
    fi
    sudo pacman -Syu --noconfirm || warning "Sistem gÃ¼ncellenemedi."

    info "yay kurulumu baÅŸlatÄ±lÄ±yor..."
    if pacman -Si yay &>/dev/null; then
        sudo pacman -S --needed --noconfirm yay && success "yay kuruldu." && return
    fi

    sudo pacman -S --needed --noconfirm base-devel git || error "Gerekli AUR araÃ§larÄ± yÃ¼klenemedi."
    rm -rf "$TMPDIR/yay-bin"
    git clone https://aur.archlinux.org/yay-bin.git "$TMPDIR/yay-bin" || error "yay klonlama baÅŸarÄ±sÄ±z."
    pushd "$TMPDIR/yay-bin" >/dev/null
    makepkg -si --noconfirm || error "yay kurulumu baÅŸarÄ±sÄ±z oldu."
    popd >/dev/null
    success "yay baÅŸarÄ±yla kuruldu."
    hash -r
}

# ===============================================================
# Paket Kurulumu
# ===============================================================
install_required_packages() {
    if [[ "$mod" -eq 1 ]]; then
        info "Dotfiles modunda paket kurulumu atlanÄ±yor."
        return
    fi

    local PKGLIST_FILE="$SCRIPT_DIR/pkglist.txt"
    [[ ! -f "$PKGLIST_FILE" ]] && error "Paket listesi bulunamadÄ±: $PKGLIST_FILE"
    if ! grep -q -E '^[^\s#]' "$PKGLIST_FILE"; then
        warning "Paket listesi boÅŸ."
        return
    fi
    mapfile -t pkgs < <(grep -E '^[^\s#]' "$PKGLIST_FILE")

    yay -S --needed --noconfirm  "${pkgs[@]}" || warning "BazÄ± paketler yÃ¼klenemedi."
    success "Paket kurulumu tamamlandÄ±."
}

# ===============================================================
# Servis EtkinleÅŸtirme
# ===============================================================
enable_system_services() {
    if [[ "$mod" -eq 1 ]]; then
        info "Dotfiles modunda servis etkinleÅŸtirme adÄ±mÄ± atlanÄ±yor."
        return
    fi

    local services=(sddm avahi-daemon power-profiles-daemon ufw NetworkManager)
    for svc in "${services[@]}"; do
        if ! sudo systemctl is-enabled "$svc" &>/dev/null; then
            sudo systemctl enable "$svc" && success "$svc etkinleÅŸtirildi."
        else
            info "$svc zaten etkin."
        fi
    done

    if command -v ufw &>/dev/null; then
        sudo ufw --force reset
        sudo ufw default deny incoming
        sudo ufw default allow outgoing
        sudo ufw --force enable

        if compgen -G "/etc/ufw/*.rules" > /dev/null; then
            sudo chmod 600 /etc/ufw/*.rules 2>/dev/null || true
        fi

        if sudo ufw status | grep -q "active"; then
            success "UFW etkin ve gÃ¼venli biÃ§imde yapÄ±landÄ±rÄ±ldÄ±."
        else
            warning "UFW etkinleÅŸtirilemedi, manuel kontrol Ã¶nerilir."
        fi
    fi

}

# ===============================================================
# Dotfiles ve KullanÄ±cÄ± AyarlarÄ±
# ===============================================================
configure_user_settings() {
    info "KullanÄ±cÄ± yapÄ±landÄ±rmalarÄ± uygulanÄ±yor..."
    rsync -a --exclude=.git --exclude=install.sh --exclude=pkglist.txt --exclude='.config/pacman/' "$SCRIPT_DIR/" "$REAL_HOME/" || error "rsync hatasÄ±."

    if [[ -d "$REAL_HOME/.config/hypr/scripts" ]]; then
        find "$REAL_HOME/.config/hypr/scripts" -type f -name "*.sh" -exec chmod +x {} \;
        success "Hyprland script izinleri ayarlandÄ±."
    fi

    info "KullanÄ±cÄ± dizinleri oluÅŸturuluyor..."
    xdg-user-dirs-update || warning "xdg-user-dirs-update baÅŸarÄ±sÄ±z."
    success "KullanÄ±cÄ± dizinleri gÃ¼ncellendi."

    local choice_sddm="E"
    if [[ "$mod" -eq 0 && "$AUTO_YES" -eq 0 ]]; then
        read -rp "SDDM iÃ§in otomatik giriÅŸ yapÄ±lsÄ±n mÄ±? (E/h): " choice_sddm || true
    fi
    if is_yes "$choice_sddm"; then
sudo tee /etc/sddm.conf >/dev/null <<EOF
[Autologin]
Relogin=false
User=$REAL_USER
Session=hyprland
EOF
        success "SDDM otomatik giriÅŸ yapÄ±landÄ±rÄ±ldÄ±."
    fi

    if [[ ! -L /usr/local/bin/gnome-terminal ]] && [[ -f /usr/bin/kitty ]]; then
        sudo ln -sf /usr/bin/kitty /usr/local/bin/gnome-terminal
        success "kitty â†’ gnome-terminal sembolik baÄŸlantÄ±sÄ± oluÅŸturuldu."
    fi
}

# ===============================================================
# Yeniden BaÅŸlatma
# ===============================================================
prompt_reboot() {
    if [[ "$mod" -eq 1 ]]; then
        info "Dotfiles modunda deÄŸiÅŸiklikleri uygulamak iÃ§in oturumu kapatÄ±p yeniden girin."
        return
    fi

    if [[ "$AUTO_YES" -eq 1 ]]; then
    info "Kurulum tamamlandÄ±. Sistem 5 saniye iÃ§inde yeniden baÅŸlatÄ±lacak..."
    sleep 5
    sudo systemctl reboot
    return
    fi


    read -rp "Kurulum tamamlandÄ±. Åžimdi yeniden baÅŸlatÄ±lsÄ±n mÄ±? (E/h): " choice
    if is_yes "$choice"; then
        sudo systemctl reboot
    else
        info "Yeniden baÅŸlatma atlandÄ±."
    fi
}

# ===============================================================
# Ana Fonksiyon
# ===============================================================
main() {
    [[ $EUID -eq 0 ]] && error "Bu betik root olarak Ã§alÄ±ÅŸtÄ±rÄ±lamaz."
    if [[ "$mod" -eq 0 ]]; then
        setup_chaotic_aur
        configure_pacman
        sudo pacman -Syu --noconfirm || warning "Sistem gÃ¼ncellenemedi."
        setup_yay
        install_required_packages
        enable_system_services
    fi
    configure_user_settings
    prompt_reboot
    echo
    success "Kurulum tamamlandÄ±!"
    info "ðŸ“œ Log kaydedildi: $LOGFILE"
    echo
}

main "$@"
